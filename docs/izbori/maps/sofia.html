<!DOCTYPE html>
<html>
<head>
    <title>Изборни резултати по секции, София</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
	<style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map { 
            width: 100%;
            height: 100%; 
        }
        
        .map-container {
            position: relative; 
            width: 100vw;
            height: 100vh;
        }
        
        .dropdown-container {
            position: absolute; 
            top: 10px;
            left: 50px;  
            background-color: rgba(255, 255, 255, 0.8); 
            padding: 5px;
            border-radius: 5px;
            z-index: 1000; 
        }
        
        .dropdown-container select {
            width: 200px;
        }

        .dropdown-container select + select {
            margin-top: 5px;
            display: block;
        }

        .info { 
            padding: 6px 8px; 
            font: 14px/16px Arial, Helvetica, sans-serif; 
            background: white; 
            background: rgba(255,255,255,0.8); 
            box-shadow: 0 0 15px rgba(0,0,0,0.2); 
            border-radius: 5px; 
        }
        
        .info h4 { 
            margin: 0 0 5px; 
            color: #777; 
        }
        
        .legend { 
            text-align: left; 
            line-height: 18px; 
            color: #555; 
        }
        
        .legend i { 
            width: 18px; 
            height: 18px; 
            float: left; 
            margin-right: 8px; 
            opacity: 0.7; 
        }

        .show-info-button {
            position: absolute;
            top: 80px;
            left: 10px;
            width: 35px;
            height: 35px;
            z-index: 900; 
            background: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            line-height: 30px;
            font: 14px/16px Arial, Helvetica, sans-serif; 
        }

        #infoBox {
            position: absolute;
            top: 50px; 
            left: 20px; 
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none; 
            font: 14px/16px Arial, Helvetica, sans-serif; 
        }
    </style>
</head>

<body>
<div class="map-container">
    <div id="map"></div>
    <div class="dropdown-container">
        <select id="csvDropdown">
            <option value="oct19r1">Окт 2019 Местни (1ви тур, ОС)</option>
            <option value="oct19">Окт 2019 Местни (2ри тур, кмет)</option>
            <option value="apr21" selected>Апр 2021 НС</option>
            <option value="jul21">Юли 2021 НС</option>
            <option value="nov21">Ное 2021 НС</option>
            <option value="oct22">Окт 2022 НС</option>
            <option value="apr23">Апр 2023 НС</option>
            <option value="oct23r1">Окт 2023 (1ви тур, кмет)</option>
            <option value="oct23r1OS">Окт 2023 (1ви тур, ОС)</option>
            <option value="oct23r2">Окт 2023 (2ри тур, кмет)</option>
            <option value="jun24">Юни 2024 НС</option>
        </select>
        <select id="columnsDropdown"></select>
        <select id="electionRegionsDropdown">
            <option value="">МИР</option>
            <option value="2346">23 МИР</option>
            <option value="2446">24 МИР</option>
            <option value="2546">25 МИР</option>
        </select>
        <select id="cityRegionsDropdown">
            <option value="">Район</option>
        </select>
    </div>

    <button id="showInfo" class="show-info-button">i</button>
    <div id="infoBox" class="info-box" style="display:none;">
        Изборните данни са от <a href=https://results.cik.bg>ЦИК</a>.<br>
        Инструменти за анализ:<a href=https://bg-izbori.herokuapp.com/>bg-izbori.herokuapp.com</a>.<br>
        Границите на секциите са предоставени от <a href=https://data-for-good.bg/>"Данни за добро"</a>.<br>
        За коментари и намерени грешки: <a href=https://twitter.com/petar_baka>@petar_baka</a>.<br>
        <button onclick="showInfoBox()">Затвори</button>
    </div>
</div> 
</body>
</html>

<script type='text/javascript'>
    let csvData;
    let geojsonData;
    let map;
    let geojsonLayer;
	var info = L.control();
    let electionDate = 'apr21'
    let selectedColumn = 'ГЕРБ-СДС';
    let selectedElectionRegion = ''
    let selectedCityRegion = ''
    
    // Load parameters from localStorage or URL
    function loadParameters() {
        const params = new URLSearchParams(window.location.search);
        electionDate = params.get('election') || localStorage.getItem('electionDate') || 'apr21';
        selectedColumn = params.get('column') || localStorage.getItem('selectedColumn') || 'ГЕРБ-СДС';
        selectedElectionRegion = params.get('electionRegion') || localStorage.getItem('selectedElectionRegion') || '';
        selectedCityRegion = params.get('cityRegion') || localStorage.getItem('selectedCityRegion') || '';
    }

    // Save parameters to localStorage and update URL
    function saveParameters() {
        localStorage.setItem('electionDate', electionDate);
        localStorage.setItem('selectedColumn', selectedColumn);
        localStorage.setItem('selectedElectionRegion', selectedElectionRegion);
        localStorage.setItem('selectedCityRegion', selectedCityRegion);

        const params = new URLSearchParams();
        params.set('election', electionDate);
        params.set('column', selectedColumn);
        if (selectedElectionRegion) params.set('electionRegion', selectedElectionRegion);
        if (selectedCityRegion) params.set('cityRegion', selectedCityRegion);

        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState(null, '', newUrl);
    }

    // Load parameters on page load
    loadParameters();

    document.getElementById("csvDropdown").addEventListener("change", function(event) {
        electionDate = event.target.value;
        saveParameters();
        updateGeojson(electionDate).then(populateDropdowns);
    });

    document.getElementById('showInfo').addEventListener('click', showInfoBox);

    loadGeoJSON(electionDate).then(initializeMap);

    const electionRegions = {
        "2346": "23 МИР",
        "2446": "24 МИР",
        "2546": "25 МИР",
    }

    const cityRegions = {
        "234617": "Витоша",
        "234602": "Красно село",
        "234615": "Младост",
        "234623": "Панчарево",
        "234610": "Триадица",
        "234616": "Студентски",
        "234608": "Изгрев",
        "234609": "Лозенец",
        "244622": "Кремиковци",
        "244601": "Средец",
        "244607": "Слатина",
        "244614": "Искър",
        "244604": "Оборище",
        "244606": "Подуяне",
        "244603": "Възраждане",
        "244605": "Сердика",
        "254620": "Връбница",
        "254619": "Люлин",
        "254613": "Надежда",
        "254611": "Красна поляна",
        "254612": "Илинден",
        "254618": "Овча Купел",
        "254621": "Нови Искър",
        "254624": "Банкя",
    };
    
    const grades = [10, 30, 50, 70, 90, 110, 130, 150];

    function loadCSV(el_date) {
        const csvFilename = "../../assets/data/mestni/sofia_" + el_date + "_pct.csv";
    
        return new Promise((resolve, reject) => {
            Papa.parse(csvFilename, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: (result) => {
                    csvData = result.data;
                    resolve(result);  
                },
                error: (error) => {
                    reject(error); 
                }
            });
        });
    }

    function updateGeojson(el_date) {
        return loadGeoJSON(el_date)
            .then(() => {
                map.removeLayer(geojsonLayer);
                const filteredFeatures = geojsonData.features.filter(
                    ({ properties }) => {
                        const sectionId = properties.id || properties.ID || properties.index
                        // Filter for election region based on district so it works for local elections too
                        return (!selectedElectionRegion || Object.keys(cityRegions).find(x => sectionId.substring(2, 6) === x.substring(2)).substring(0, 2) === selectedElectionRegion.substring(0, 2) )
                        // Filter based on city region without the election region so it works for local elections too
                            && (!selectedCityRegion || sectionId.substring(2, 6) === selectedCityRegion.substring(2))
                    }
                )
                geojsonData.features = filteredFeatures
    
                geojsonLayer = L.geoJson(geojsonData, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
            })
            .catch(error => {
                console.error("Failed to load new GeoJSON data:", error);
            });
    }

    function loadGeoJSON(el_date) {
      const jsonFile = "../../assets/data/mestni/sofia_" + el_date + ".json";
      console.log(jsonFile);

      return fetch(jsonFile)
        .then((response) => response.json())
        .then((data) => {
          geojsonData = data;
          return loadCSV(el_date); 
        });
    }

    function matchData(columnName) { // TODO: get rid of this (no need to add data to the GeoJSON features; you can fetch data dynamically from the csv as needed)
      geojsonData.features.forEach((feature) => {
        const match = csvData.find((row) => ('0' + row.id).slice(-9) === feature.properties.sid); 
        if (match) {
          //console.log(match, columnName)
          feature.properties[columnName] = match[columnName];
          feature.properties['total'] = match['total']; 
          feature.properties['eligible_voters'] = match['eligible_voters']; 
          feature.properties['активност'] = match['активност']; 
        } else {
          console.log('no match ', columnName)
          feature.properties[columnName] = NaN;
          feature.properties['total'] = NaN; 
          feature.properties['eligible_voters'] = NaN; 
          feature.properties['активност'] = NaN; 
        }
      });
    }

	function style(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.7,
            fillColor: getColor(Math.round(feature.properties[selectedColumn] * feature.properties.total)),
		};
	}

	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties, selectedColumn);
	}

	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}


	function resetHighlight(e) {
		geojsonLayer.resetStyle(e.target);
		info.update(undefined, selectedColumn);
	}

	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomToFeature,
			dbclick: function(e) {
                highlightFeature(e);
                zoomToFeature(e);
            }
		});
	}

    function initializeMap() {
	  map = L.map('map').setView([42.691, 23.333], 12);
    
	  var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
	  	maxZoom: 19,
	  	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>|<a href="https://twitter.com/petar_baka">petar_baka</a>|<a href="https://data-for-good.bg/">Данни за добро</a>'
	  }).addTo(map);

      geojsonLayer = L.geoJson(geojsonData, {
       	style: style,
      	onEachFeature: onEachFeature
      }).addTo(map);

	  info.onAdd = function (map) {
	  	this._div = L.DomUtil.create('div', 'info');
	  	this.update();
	  	return this._div;
	  };

	  info.update = function (props, selectedColumn) {
        var selectedYear = document.getElementById('csvDropdown');
        var selectedYearText = selectedYear.options[selectedYear.selectedIndex].textContent;;
        var table = ''; 
	  	var textbox = '<h4>Резултати ' + selectedColumn + ' (' + selectedYearText + ')</h4>';
        let targetRows = csvData.filter(row => !!row.id);

        if (props) {
            targetRows = targetRows.filter((row) => (row.id + '').startsWith(props.sid))
            table = generateTableHtmlForRows(targetRows);

            textbox += '<b>Секция ' + props.sid + '</b>';
            textbox += '&nbsp;&nbsp;Район: <b>' + getCityRegionName(props.sid.substring(2, 6)) + '</b><br>';

            if (selectedColumn !== 'активност') {
                textbox += selectedColumn + ' гласове: ' +  Math.round(props[selectedColumn]*props['total']) + '<br>' 
            } else {
                // TODO: breakdown valid votes, invalid votes, total 
                // TODO: breakdown initial voter list, added to voter list, total 
                textbox += 'Общо валидни гласове: ' +  Math.round(props[selectedColumn]*props['eligible_voters']) + '<br>' 
                textbox += 'Избиратели по списък: ' +  props['eligible_voters'] + '<br>'
            }
            textbox += selectedColumn + ` (%): ${isNaN(props[selectedColumn]) ? props[selectedColumn] : (100*props[selectedColumn]).toFixed(1)}<br>`
            textbox += table + '<br>'
            textbox += 'Общо валидни гласове: ' +  props['total']  + '<br>'
            textbox += 'Избиратели по списък: ' +  props['eligible_voters'] + '<br>'
            textbox += `Валидни гласове/избиратели по списък: ${isNaN(props['активност']) ? props['активност'] : props['активност'].toFixed(2)}<br>`
        } else {
            targetRows = selectedCityRegion
              ? targetRows.filter((row) => (row.id + '').substring(2, 6) === selectedCityRegion.substring(2))
              : selectedElectionRegion
                ? targetRows.filter((row) => Object.keys(cityRegions).find(x => (row.id + '').substring(2, 6) === x.substring(2)).substring(0, 2) === selectedElectionRegion.substring(0, 2))
              : targetRows;

            textbox += 'Общ резултат за <b>'
              + (selectedCityRegion
                ? 'Район ' + cityRegions[selectedCityRegion]
                : selectedElectionRegion
                  ? electionRegions[selectedElectionRegion]
                  : 'Столична община'
                )
              + '</b><br>';
            if (selectedColumn !== 'активност') {
                textbox += selectedColumn + ' гласове: ' + targetRows.reduce((acc, x) => acc + Math.round(x[selectedColumn] * x.total), 0) + '<br>' 
            } else {
                // TODO: breakdown valid votes, invalid votes, total 
                // TODO: breakdown initial voter list, added to voter list, total 
                textbox += 'Общо валидни гласове: ' + targetRows.reduce((acc, x) => acc + Math.round(x[selectedColumn] * x.eligible_voters), 0) + '<br>' 
                textbox += 'Избиратели по списък: ' +  targetRows.reduce((acc, x) => acc + x.eligible_voters, 0) + '<br>'
            }
            textbox += generateTableHtmlForRows(targetRows)
        };

	  	this._div.innerHTML = textbox;
	  };

	  info.addTo(map);

      var legend = L.control({position: 'bottomleft'});

      legend.onAdd = function (map) {

          var div = L.DomUtil.create('div', 'info legend');
          var labels = [];
          var from, to;

          for (var i = 0; i < grades.length; i++) {
              from = grades[i];
              to = grades[i + 1];

              labels.push(
                  '<i style="background:' + getColor(from + 0.0001) + '"></i> ' +
                  from + (to ? '&ndash;' + to : '+'));
          }

          div.innerHTML = labels.join('<br>');
          return div;
      };

      legend.addTo(map);

      populateDropdowns();
        
        // Set initial dropdown values
        document.getElementById("csvDropdown").value = electionDate;
        document.getElementById("electionRegionsDropdown").value = selectedElectionRegion;
        document.getElementById("cityRegionsDropdown").value = selectedCityRegion;
    }
    
    function populateDropdowns() {
      const dropdown = document.getElementById("columnsDropdown");
      const columns = Object.keys(csvData[0]);
      let parties = [];
      const excluded = ['id', 'eligible_voters', 'total'];

      dropdown.innerHTML = ''; 
    
      columns.forEach((column) => {
        
        if (! excluded.includes(column)) { 
          const option = document.createElement("option");
          option.value = column;
          option.textContent = column;
          dropdown.appendChild(option);
          parties.push(column)
        }
      });
   
      if ((selectedColumn == null) || !( columns.includes(selectedColumn))) { 
        selectedColumn = parties[0]; 
      } else if (columns.includes(selectedColumn)) {
        dropdown.value = selectedColumn;
      };

      updateColumn({ target: { value: selectedColumn } })
      dropdown.removeEventListener("change", updateColumn);
      dropdown.addEventListener("change", updateColumn);

      populateElectionRegionsDropdown();
      populateCityRegionsDropdown(selectedElectionRegion);
    }

    function updateFillData() {
        updateColumn({ target: { value: selectedColumn } })
    }

    function changeSelectedElectionRegion(event) {
        selectedElectionRegion = event.target.value;
        saveParameters();
        populateCityRegionsDropdown(selectedElectionRegion);
        updateGeojson(electionDate).then(updateFillData);
    }

    function getCityRegionName(municipalityRegionCode) {
        return Object.entries(cityRegions).find(([prefix, name]) => prefix.substring(2, 6) === municipalityRegionCode)[1]
    }

    function populateElectionRegionsDropdown() {
        const dropdown = document.getElementById('electionRegionsDropdown')
        dropdown.removeEventListener('change', changeSelectedElectionRegion)
        dropdown.addEventListener("change", changeSelectedElectionRegion);
    }

    function changeSelectedCityRegion(event) {
        selectedCityRegion = event.target.value;
        saveParameters();
        updateGeojson(electionDate).then(updateFillData);
    }

    function populateCityRegionsDropdown(prefixFilter = '') {
        const dropdown = document.getElementById('cityRegionsDropdown')
        dropdown.removeEventListener('change', changeSelectedCityRegion)

        // remove dropdown options after first
        while (dropdown.options.length > 1) {
            dropdown.remove(1);
        }

        Object.entries(cityRegions)
            // Filter city regions to matching election regions
            .filter(([prefix, name]) => prefix.startsWith(prefixFilter))
            // Sort city regions by name
            .sort(([prefixA, nameA], [prefixB, nameB]) => nameA.localeCompare(nameB))
            .forEach(([prefix, name]) => {
                const option = document.createElement('option')
                option.value = prefix
                option.textContent = name
                if (option.value === selectedCityRegion) {
                  option.selected = true
                }
                dropdown.appendChild(option)
            })
        if (dropdown.value !== selectedCityRegion) {
          selectedCityRegion = ''
        }
        dropdown.addEventListener('change', changeSelectedCityRegion);
    }
    
    function updateColumn(event) {
      selectedColumn = event.target.value;
      saveParameters();
      matchData(selectedColumn);
      geojsonLayer.setStyle(feature => {
        return {
          fillColor: getColor(Math.round(feature.properties[selectedColumn] * feature.properties.total)),
        };
      });
      info.update(undefined, selectedColumn);
    }

    function generateTableHtmlForRows(targetRows) {
        if (targetRows.length === 0) return '';
    
        let html = '<table>';
    
        html += '<thead><tr>';
        html += '<th>Партия/Кандидат</th>';
        html += '<th>Гласове</th>';
        html += '<th>Гласове/<br>общо валидни</th>';
        html += '</tr></thead>';
    
        html += '<tbody><tr>';
        const allTotal = targetRows.reduce((acc, x) => acc + parseInt(x.total, 10), 0)
        for (let key in targetRows[0]) {
            if (key !== "total" && key !== "id" && key !== 'eligible_voters' && key !== 'активност') {
                const votes = targetRows.reduce((acc, x) => acc + Math.round(x[key] * parseInt(x.total, 10)), 0)
                const percentage = votes / allTotal * 100

                html += `<tr>`;
                html += `<td>${key}</td>`;
                html += `<td>${votes}</td>`;
                html += `<td>${isNaN(percentage) ? percentage : percentage.toFixed(2) + '%'}</td>`;
                html += `</tr>`;
            }
        }
        html += '</tr></tbody>';
    
        html += '</table>';
        return html;
    }

    function interpolateColor(color1, color2, factor) {
        const r = Math.round(color1[0] + factor * (color2[0] - color1[0]));
        const g = Math.round(color1[1] + factor * (color2[1] - color1[1]));
        const b = Math.round(color1[2] + factor * (color2[2] - color1[2]));
        return `rgb(${r}, ${g}, ${b})`;
    }
    
    function getColor(d) {
        const colors = [ // check out https://colorbrewer2.org/?type=sequential&scheme=YlOrRd&n=9
            [255,255,245],
            [255,247,245],
            [255,247,236],
            [253,212,158],
            [254,232,200],
            [254,230,192],
            [239,101,72],
            [215,48,31],
            [179,0,0],
        ];

        if (isNaN(d) || d <= 0) return 'rgb(' + colors[0].join(',') + ')';
        if (d >= 150) return 'rgb(' + colors[colors.length - 1].join(',') +')';

        const index = grades.findIndex(x => d < x);
        // const factor = (d / 65) - index;
        
        return 'rgb(' + colors[index].join(',') + ')'
    
        // return interpolateColor(colors[index], colors[index + 1], factor);
    }

    function showInfoBox() {
        var infoBox = document.getElementById('infoBox');
        if (infoBox.style.display === 'none') {
            infoBox.style.display = 'block';
        } else {
            infoBox.style.display = 'none';
        }
    }


</script>
